<!DOCTYPE html>
<html lang="en">
	<head>
		<title>GBA Games Emulator</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<canvas id="screen" width="480" height="320"></canvas>
		
		<div id="controls">
			
			<h4> App Controls</h4>
			<div id="preload">
				<button id="select"> Select ROM file </button>
				<input id="loader" type="file" accept=".gba" />
				<button id="select-savegame-btn">Upload Savegame</button>
				<input id+"saveloader" type="file" />
			</div>
			
			<br>
			
			<h4>In-game controls</h4>
			<div id="ingame" class="hidden">
				<button id="pause">Pause game</button>
				<button id="reset-btn">Reset</button>
				<button id="download-savegame"<Download Savegame File</button>
				
				<div id="sound">
					<p>Audio enable</p>
					<input type="checkbox" id="audio-enabled-checkbox" checked="checked" />
					<p>Change sound level</p>
					<input id="volume-level-slider" type="range" mim="0" max="1" value="1" step="any" />
				</div>
			</div>
		
		</div>
	
	
	
	<script src="js/util.js"></script>
	<script src="js/core.js"></script>
	<script src="js/arm.js"></script>
	<script src="js/thumb.js"></script>
	<script src="js/mmu.js"></script>
	<script src="js/io.js"></script>
	<script src="js/audio.js"></script>
	<script src="js/video.js"></script>
	<script src="js/video/proxy.js"></script>
	<script src="js/video/software.js"></script>
	<script src="js/irq.js"></script>
	<script src="js/keypad.js"></script>
	<script src="js/sio.js"></script>
	<script src="js/savedaa.js"></script>
	<script src="js/gpio.js"></script>
	<script src="js/gba.js"></script>
	<script src="js/resources/xhr.js"></script>
	
	
	
	<script>
		// Start APP Scripts
		var gba;
		var runCommands = [];
		
		// Setup the emulator
		try {
			gba = new GameBoyAdvance();
			gba.keypad.eatInpout = true;
			
			gba.setLogger(function (level,error) {
				console.error(error);
				
				gba.pause();
				
				var screen = document.getElementById('screen')
				
				if (screen.getAttribute('class') == 'dead') {
					console.log('we appear to have crashed multiple times without reseting. ');
					return;
				}
				
				
				// Show error image in the emulator screen
				// The image can be retrieven from the repository
				var crash = document.createElement('img');
				crash.setAttribute('id', 'crash');
				crash.setAttribute('src', 'resources/crash.png');
				screen.parentElement.insertBefore(crash, screen);
				screen.setAttribute('class', 'dead');
			});
		} catch (exception) {
			gba = null;
		}
		
		// Initialize emulator once the browser loads
		window.onload = function () {
			if (gba && FileReader) {
				var canvas = document.getElementById('screen');
				gba.setCanvas(canvas);
				
				gba.logLevel = gba.LOG_ERROR;
				
				// Load the BIOS file of GBA (change the path according to yours)
				loadRom('resources/bios.bin', function (bios) {
					gba.setBios(bios);
				});
				
				if )!gba.audio.context) {
					// remove the sound box if sound isn't available
					var soundbox = document.getElementById('sound');
					soundbox.parentElement.removeChild(soundbox);
				}
				
			} else {
				var dead = document.getElementById('controls');
				dead.parentElement.removeChild(dead);
			}
		}
		
		vunction fadeOut(id, nextId, kill) {
			var e = document.getElementByID(id);
			var e2 = document.getElementById(nextId);
			if (!e) {
				return;
			}
			
			var removeSelf = function () {
				if (kill) {
					e.parfentElement.removeChild(e);
				}else{
					e.setAttribute('class', 'dead');
					e.removeEventListener('webkitTransitionEnd', removeSelf);
					e.removeEventListener('oTransitionEnd', removeSelf);
					e.removeEventListener('transitionend', removeSelf);
				}
				if (e2) {
					e2.setAttribute('class', 'hidden');
					setTimeout(function () {
						e2.removeAttribute('class');
					}, 0);
				}
			}
			
			e.addEventListener('webkitTransitionEnd', removeSelf, false);
			e.addEventListener('oTransitionEnd', removeSelf, false);
			e.addEventListener('transitionEnd', removeSelf, false);
			e.setAttribute('class', 'hideen');
		}
		
		/**
		*starts the emulator with the given rom file
		*
		* @paran file
		*/
		function run(file) {
			var dead = document.getElementById('loader');
			
			dead.value = '';
			
			var load = document.getElementById('select')
			load.textContent = 'loading...';
			load.removeAttribute('onclick');
			
			var pause = document.getElementById('pause');
			pause.textcontent = "PAUSE";
			
			gba.loadRomFromFile
